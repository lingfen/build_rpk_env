"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function signZip(e,t,n,r){var a=Buffer.from(_signature2.default.Base64.unarmor(n)),i=new _jsrsasign2.default.X509;i.readCertPEM(n.toString());var s=_jsrsasign2.default.KEYUTIL.getPEM(i.subjectPublicKeyRSA),l=_fs2.default.readFileSync(e.zip);if(!l||l.length<=4)return _utils.colorconsole.error("### App Loader ### Zip文件打开失败:",e.zip),!1;var u=l.readInt32LE(0);if("4034b50"!==u.toString(16).toLowerCase())return _utils.colorconsole.error("### App Loader ### Zip文件格式错误:",e.zip),!1;var o=parserZip(l);return o.options=e,o.tag&&(Object.keys(o.sections).forEach(function(e){var n=o.sections[e];processChunk(l,n,t)}),signChunk(o,t,s,a),r||(r=makeSignFile(e.zip)),saveChunk(l,o,r)),!0}function parserZip(e){var t={tag:!1,length:e.length,sections:{header:null,central:null,footer:null}};return t.sections.footer=readEOCD(e),t.sections.footer.tag&&(t.sections.central=readCD(e,t.sections.footer.previous,t.sections.footer.startIndex-t.sections.footer.previous),t.sections.central.tag&&(t.sections.header=readFH(e,t.sections.central.previous,t.sections.central.startIndex-t.sections.central.previous),t.sections.header.tag&&(t.tag=!0))),t}function readEOCD(e){var t={tag:!1};if(e&&e.length>=22)for(var n=e.length-22,r=void 0;n>=0;){if(r=e.readInt32LE(n),"6054b50"===r.toString(16).toLowerCase()){t.tag=!0,t.startIndex=n,t.len=e.length-n,t.previous=e.readInt32LE(n+16);break}n-=1}return t}function readCD(e,t,n){var r={tag:!1};if(e&&e.length>=t){var a=e.readInt32LE(t);"2014b50"===a.toString(16).toLowerCase()&&(r.tag=!0,r.startIndex=t,r.len=n,r.previous=e.readInt32LE(t+42))}return r}function readFH(e,t,n){var r={tag:!1};if(e&&e.length>=t){var a=e.readInt32LE(t);"4034b50"===a.toString(16).toLowerCase()&&(r.tag=!0,r.startIndex=t,r.len=n,r.previous=-1)}return r}function processChunk(e,t,n){var r=t.startIndex,a=t.startIndex+t.len,i=e.slice(r,a),s=Buffer.alloc(5+t.len);s[0]=165,s.writeInt32LE(i.length,1),i.copy(s,5);var l=_crypto2.default.createHash("SHA256");l.update(s),t.sign=l.digest()}function hashFile(e,t){var n=t.readFileSync(e),r=_crypto2.default.createHash("SHA256");return r.update(n),r.digest()}function signChunk(e,t,n,r){function a(e){e.copy(l,u),u+=e.length}var i=e.sections,s=i.header.sign.length+i.central.sign.length+i.footer.sign.length+5,l=Buffer.alloc(s),u=0;l.writeInt8(90,0),l.writeInt32LE(3,1),u+=5,a(i.header.sign),a(i.central.sign),a(i.footer.sign);var o=_crypto2.default.createHash("SHA256");o.update(l);var f=o.digest(),g=makeSignChunk(e.options,f,t,n,r);e.signchunk=saveSignChunk(g)}function makeSignChunk(e,t,n,r,a){var i=Buffer.alloc(t.length+12);i.writeInt32LE(t.length+8,0),i.writeInt32LE(259,4),i.writeInt32LE(t.length,8),t.copy(i,12);var s={len:i.length,buffer:i},l=Buffer.alloc(a.length+4);l.writeInt32LE(a.length,0),a.copy(l,4);var u={len:l.length,buffer:l},o={len:12,digests:{size:0,data:[]},certs:{size:0,data:[]},additional:0};o.digests.data.push(s),o.digests.size+=s.len,o.len+=s.len,o.certs.data.push(u),o.certs.size+=u.len,o.len+=u.len;var f=Buffer.from(_signature2.default.Base64.unarmor(r)),g={len:16+f.length,size:12+f.length,signdata:{size:0,buffer:null},signatures:{size:0,data:[]},pubkey:{size:f.length,buffer:f}};g.signdata.buffer=makeSignDataBuffer(o),g.signdata.size=o.len,g.size+=o.len,g.len+=o.len;var c=_crypto2.default.createSign("RSA-SHA256");c.update(g.signdata.buffer);var d=c.sign(n),h={len:d.length+12,size:d.length+8,id:259,buffer:d};g.signatures.data.push(h),g.signatures.size+=h.len,g.size+=h.len,g.len+=h.len;var p={len:4,size:0,data:[]};p.data.push(g),p.size+=g.len,p.len+=g.len;var v={len:p.len+12,size:p.len+4,id:16777473,value:p},I={len:32,size:24,data:[]};if(I.data.push(v),I.size+=v.len,I.len+=v.len,e.files){var E=signFiles(e.files,n);if(E){var L={len:4,size:0,data:[]};L.data.push(E),L.size+=E.length,L.len+=E.length;var z={len:L.len+12,size:L.len+4,id:16777729,value:L};I.data.push(z),I.size+=z.len,I.len+=z.len}}return I}function makeSignDataBuffer(e){var t=Buffer.alloc(e.len),n=0;return t.writeInt32LE(e.digests.size,n),n+=4,e.digests.data.forEach(function(e){e.buffer.copy(t,n),n+=e.len}),t.writeInt32LE(e.certs.size,n),n+=4,e.certs.data.forEach(function(e){e.buffer.copy(t,n),n+=e.len}),t.writeInt32LE(e.additional,n),t}function saveSignChunk(e){var t=Buffer.alloc(e.len),n=0;t.writeInt32LE(e.size,n),n+=4,t.writeInt32LE(0,n),n+=4,e.data.forEach(function(e){t.writeInt32LE(e.size,n),n+=4,t.writeInt32LE(0,n),n+=4,t.writeInt32LE(e.id,n),n+=4,t.writeInt32LE(e.value.size,n),n+=4,16777473===e.id?e.value.data.forEach(function(e){t.writeInt32LE(e.size,n),n+=4,t.writeInt32LE(e.signdata.size,n),n+=4,e.signdata.buffer.copy(t,n),n+=e.signdata.buffer.length,t.writeInt32LE(e.signatures.size,n),n+=4,e.signatures.data.forEach(function(e){t.writeInt32LE(e.size,n),n+=4,t.writeInt32LE(e.id,n),n+=4,t.writeInt32LE(e.buffer.length,n),n+=4,e.buffer.copy(t,n),n+=e.buffer.length}),t.writeInt32LE(e.pubkey.size,n),n+=4,e.pubkey.buffer.copy(t,n),n+=e.pubkey.buffer.length}):16777729===e.id&&e.value.data.forEach(function(e){e.copy(t,n),n+=e.length})}),t.writeInt32LE(e.size,n),n+=4,t.writeInt32LE(0,n),n+=4;var r=Buffer.from(SigMagic);return r.copy(t,n),t}function makeSignFile(e){var t=_path2.default.extname(e),n=_path2.default.dirname(e),r=_path2.default.basename(e,t);return _path2.default.join(n,r+".signed"+t)}function saveChunk(e,t,n){var r=Buffer.alloc(e.length+t.signchunk.length),a=0,i=t.sections;e.copy(r,a,i.header.startIndex,i.header.startIndex+i.header.len),a+=i.header.len,t.signchunk.copy(r,a),a+=t.signchunk.length,e.copy(r,a,i.central.startIndex,i.central.startIndex+i.central.len),a+=i.central.len,e.writeInt32LE(i.central.startIndex+t.signchunk.length,i.footer.startIndex+16),e.copy(r,a,i.footer.startIndex,i.footer.startIndex+i.footer.len),a+=i.footer.len,_fs2.default.writeFileSync(n,r)}function signFiles(e,t,n){var r={len:8,size:4,digests:[],sign:null};return e.forEach(function(e){var t=_signature2.default.CRC32.digest(e.name.toString()),n=6+e.hash.length,a=Buffer.alloc(n),i=0;a.writeInt32LE(t,i),i+=4,a.writeInt16LE(e.hash.length,i),i+=2,e.hash.copy(a,i),i+=e.hash.length,r.digests.push(a),r.size+=n,r.len+=n}),signDigestChunk(r,t),saveDigestChunk(r,n)}function signDigestChunk(e,t){var n=Buffer.alloc(e.size),r=0;n.writeInt32LE(259,r),r+=4,e.digests.forEach(function(e){e.copy(n,r),r+=e.length}),e.digests=n.slice();var a=_crypto2.default.createSign("RSA-SHA256");a.update(n);var i=a.sign(t);e.sign={len:12+i.length,size:8+i.length,id:259,data:i},e.len+=e.sign.len}function saveDigestChunk(e,t){var n=Buffer.alloc(e.len),r=0;return n.writeInt32LE(e.size,r),r+=4,e.digests.copy(n,r),r+=e.digests.length,n.writeInt32LE(e.sign.size,r),r+=4,n.writeInt32LE(e.sign.id,r),r+=4,n.writeInt32LE(e.sign.data.length,r),r+=4,e.sign.data.copy(n,r),r+=e.sign.data.length,t&&_fs2.default.writeFileSync(t,n),n}var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_crypto=require("crypto"),_crypto2=_interopRequireDefault(_crypto),_signature=require("./signature"),_signature2=_interopRequireDefault(_signature),_jsrsasign=require("jsrsasign"),_jsrsasign2=_interopRequireDefault(_jsrsasign),_utils=require("./utils"),SigMagic="RPK Sig Block 42";module.exports={signZip:signZip,hashFile:hashFile};